# 一种2D-3D影像配准算法
程敏, 汤翔

---

# 研究背景

在手术导航中，需要将术前的基于CT的手术计划数据和术中X射线投影影像进行配准以提高到达目标位置的精度，当前的算法实现通常使用3D CT影像生成2D数字重建放射(Digital Reconstructed Radiograph, DRR)影像，计算DRR影像和透视影像之间的相似度，找到CT的某个位姿使生成的DRR影像和透视影像具有最佳的相似度。

在三维自由空间中，目标变量具有6个自由度，其中3个用于进行旋转，3个用于进行平移，传统的基于模板匹配的相似度评价算法和基于随机采样搜索的算法无法得到精准的结果，且计算耗时，无法应用于实际手术场景。

# 方法设计

配准步骤如下：
1. 术前扫描患者患处得到术前3D影像，在术中对患者患处进行正侧位透视扫描得到正侧位2D透视影像
2. 构建术中正侧位透视影像设备的空间模型，根据步骤1计算术前3D影像在此空间模型中的初始位姿
3. 采用第2步中构建的空间模型生成术前3D影像的正侧位DRR影像，将之与2D透视影像进行模板匹配，得到术前3D影像粗匹配变换位姿
4. 采用梯度下降优化进行优化匹配得到最终变换位姿

![[2D-3D影像配准算法框架流程.png]]
<center><font color=silver>图1 配准算法流程图</font></center>

---
构建术中正侧位透视影像的空间模型：
1. 通过C臂机或CT机在术前扫描患者患处，对术前3D影像进行分割得到椎骨图像，进而得到椎骨的中心点位置(椎骨中心点在影像坐标系下的坐标)和包围盒(椎骨的外接长方体)
2. 通过C臂机或CT机在书中对患者患处进行正侧位透视扫描，得到患者换出的正侧位术中2D透视影像，使用透视变换矩阵得到单个椎骨影像，在术中2D透视影像中的椎骨中心点加上标记
3. 以X射线发射管中心作为空间模型光心，C臂机成像平面作为空间模型成像平面，并根据构建的空间模型中的成像平面位姿以及2中标记的术中2D透视影像的椎骨中心点坐标可以计算出术中2D透视影像中的椎骨中心点在空间模型中的位置坐标
4. 根据1中得到的椎骨中心点在影像坐标系下的坐标，计算3D影像在空间模型中的初始位姿$T_0[r_0,t_0]$
5. 采用3中的空间模型生成术前3D影像正侧位2D DRR影像，从X射线源向2D DRR成像平面每个像素的方向进行采样，由公式$I_{xy}=e^{-\int i}$计算像素值，其中$i$是术前3D影像的采样值，此处作为衰减系数。生成原理如下图2所示：

![[术前CT影像中模拟X光机生成DRR影像原理.png]]
<center><font color=silver>图2 术前CT影像模拟X光机生成DRR影像原理</font></center>	

---
粗匹配变换位姿计算如下：
- 通过模板匹配计算生成的DRR影像和2D透视影像的归一化相关匹配值，得到最佳匹配位置，据此计算术前3D影像粗匹配后的平移向量
- 对于初始欧拉角，分别以生成的DRR影像的每个分量角度以预设的偏差取值，并分别计算其与对应2D透视影像之间的归一化相关匹配值，得到匹配值最高的欧拉角
- 至此，我们就得到了粗匹配变换位姿的三维平移向量和三维欧拉角

---
梯度下降优化过程如下：
- 将术前3D影像的粗匹配变换位姿作为待优化变量
- 分别计算正侧位透视影像的梯度图和经过粗匹配变换后的3D影像生成的DRR影像的梯度图，以二者之间的相似度值作为评价函数
- 使用Scharr算子计算DRR影像的梯度图和术中2D透视影像的梯度图
- 相似度值$metric$计算如下：
$$
\begin{equation}
\begin{aligned}
metric_{AP}&=\sum_x\sum_y\frac{V_{AP}}{V_{AP}+(G_{AP}-G\_DRR_{{AP}})^2}\\
metric_{LT}&=\sum_x\sum_y\frac{V_{LT}}{V_{LT}+(G_{LT}-G\_DRR_{{LT}})^2}\\
metric&=metric_{AP}+metric_{LT}
\end{aligned}
\end{equation}
$$
	其中$G_{AP}$表示正位2D透视影像的梯度图，$G\_DRR_{AP}$表示正位DRR影像的梯度图，$V_{AP}$表示正位透视影像的方差；$G_{LT}$表示侧位2D透视影像的梯度图，$G\_DRR_{LT}$表示侧位DRR影像的梯度图，$V_{LT}$表示侧位透视影像的方差；总相似度为二者相加
- 计算当前位姿$T$的梯度梯度由每个分量的导数组成，设定偏差为$\Delta$，则$dT_i=\frac{metric(T_i+\Delta)-metric(T_i-\Delta)}{2\Delta}$
- 沿着梯度方向优化当前位姿$T$，优化后的变量$T'_i$为：$T'_i=T_i+dT_i*f$，其中的$f=\frac{stepLength}{gradientMagnitude}$为梯度因子，$gradientMagnitude$是梯度$dT$的步长，$stepLength$是优化步长
- 计算振荡系数$shakeFactor=\sum_{i=1}^6dT_i+dPT_i$，其中$dPT_i$是上一次迭代得到的$PT$每一分量的导数，初值设为0，若$shakeFactor<0$则$stepLength$调整为之前的一半，重新确定偏差，跳转至计算$T_i$的导数，否则继续向下计算
- 判断$stepLength$是否满足终止条件$stepLength<0.03$，若不满足，重新确定偏差，跳转至计算$T_i$的导数
