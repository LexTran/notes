# 面向脊柱微创手术导航的2D/3D图像配准技术研究
颜立祥

---

# 研究背景

## 研究意义

手术导航基于CT、MRI等医学影像数据通过虚拟现实技术对病变组织进行定位追踪而获得位姿信息，从而实现术中实时引导

手术导航可以实现术中对患者及剖结构的快速精准的定位，以此降低手术风险，但是收到手术室空间、成像条件等限制，很难在术中进行实时3D成像，因此需要将术前的3D图像(常是CT)与术中图像(常是X光)进行配准，这就是2D/3D配准

2D/3D配准的实质是把术前3D图像作为浮动图像，降低它的维度后与术中2D参考图像进行配准对齐，使得两者相似度最高。这一过程涉及投影算法、空间变幻、插值操作和相似性度量等内容

在脊椎手术导航中主要使用X-ray或CT进行引导。 X-ray引导是临床手术中的常用方法，成像设备简单，成像速度快，但它是一种2D成像设备，无法提供病人脊椎的3D位姿信息；CT引导能够提供3D位姿信息，但是成像速度慢，设备体型庞大，仪器昂贵，难以在手术中对患者进行CT拍摄。所以一个思路是将X-ray和CT进行结合，将术前的3DCT图与术中的2DX光图像进行配准，间接为医生提供实时3D位姿信息

传统的方法如基于灰度、基于特征的方法不仅局限性高，配准精度低，且配准时间长

## 研究现状

根据配准算法使用传统方法还是深度学习方法，可将2D/3D配准分为传统迭代的配准和基于深度学习的配准

![[2D-3D图像配准分类.png]]
<center><font color=silver>图1.1 2D/3D图像配准分类</font></center>
近年传统迭代配准方法进展：
王雷等人提出基于灰度距离信息的2D/3D刚体配准，对灰度值相等的像素点求其欧氏距离之和，这样处理比单一的灰度信息多出了像素坐标信息和像素数目信息，减小了搜索空间，提高了算法的效率和精度；
陈智强等人将机器学习与几何变换进行融合对目标脊椎进行建模，再通过模型回归投影参数；
Bifulco等人通过2D动态荧光检查对椎骨进行定位，用光流场模拟真实形变场，提升配准精度；
姚明青等人提出一个强化学习智能体，引导浮动图像朝着参考图像位姿进行形变以完成配准。

基于深度学习的配准大致分为三个方向：1）深度迭代配准；2）监督学习配准；3）非监督学习配准

深度迭代配准：又可细分为传统配准方法的升级——深度学习用于提取特征，迭代优化仍采用传统方法；以及采用深度强化学习的方法。
Yipeng Hu等人描述了一种对抗性学习方法用于约束CNN训练以进行图像配准，训练过程中配准网络同时进行两个操作：最大程度地提高驱动图像对齐的解剖标记之间的相似度以及最大程度地减少对抗生成器的损失，此损失能够度量预测的变形与模拟的变形之间的差异；
Alireza Sedghi等人提出了一种从大致对齐的训练数据中学习此类指标的策略，实现了从监督到半监督学习的深度度量配准；
Grant Haskins等人提出使用DCNN了解MR-TRUS配准的相似性指标，还是用一种符合优化策略探索解决方案空间为学习指标的二阶优化寻找合适的初始化；
Rui Liao等人使用策略学习寻找能使图像配准的最佳动作序列。此方案将学习人工代理，使用DCNN建模网络，将3D原始图像作为输入，最佳动作作为输出；
Shun Miao等人提出了一种具有自注意力机制的多主体系统，用于图像配准。讲一个个体代理经过扩张的FCN的训练，可以通过观察本地区域在Markov决策过程(Markov Decision Process, MDP)中进行注册，然后根据来自多个代理的提议采取最终行动，对其权重进行加权相应的置信度；
Guorong Wu等人提出了一种非监督的特征提取方法用于配准，采用Stack Autoencode(SAE)网络进行非监督学习特征，得到泛化能力更强的特征；
Xi Cheng等人用深度学习学习两个patch块的相似性度量从而衡量两个点的匹配程度；
Julian Krebs等人使用人工智能体优化形变模型的参数

监督学习：迭代学习一大缺点是速度很慢，无法满足实时配准需求，因此出现了通过NN直接估计形变场的方法，直接利用NN回归变换参数
SSM Salehi等人提出了一种3D旋转表示来帮助搭建用于3D配准的CNN回归模型；
Evelyn Chee等人利用一个回归网络直接从原图中回归出仿射矩阵的12个参数；
Shun Miao等人提出了用于实时2D/3D配准的CNN回归方法，与基于优化的方法不同，此方法基于表示配准质量的标量值度量函数迭代优化转换参数，利用了X射线DRR图像和X射线图像外观中嵌入的信息，采用CNN回归其直接估算转换参数；
Shun Miao他们还提出了一种从局部图像的残差特征中通过CNN回归仿射矩阵的参数残差的方法；
Seyed Sadegh Mohseni Salehi等人提出一种基于深度学习的3D刚体配准，对子宫内扫描的胎儿图像进行配准；
Schaffert等人提出了一种基于学习对应加权的方法改善配准效果，加入注意力机制提高算法的鲁棒性

无监督学习配准：相较于监督学习，无监督学习方法只需要提供配准对，不需要标签(真实形变场)
Guha Balakrishnan等人提出了Voxelmorph模型，该模型已成为配准领域的SOTA。Voxelmorph结合了弱监督，融入了微分同胚机制设计了一个NN；
范敬凡等人提出一种用于图像配准的无监督对抗相似网络，不需要真实变形和特定的相似性度量，利用来自鉴别网络的反馈训练配准网络，该鉴别网络被设计为判断一对配准图像是否足够相似；
Pingkun Yan等人提出了一种对抗图像配准框架，同时训练生成器和鉴别器获得配准网络和质量评价网络；
Bhalodia等人提出了一种新颖的NN，同时学习和使用空间变换的种群级统计数据对NN进行无监督图像配准正则化；
Mingyoung Chung等人提出一种采用投票机制的集群来进行配准，使用轻量级NN提取图像特征；
de Vos等人对一个含有回归器、空间变换器和重采样器的CNN进行无监督端到端训练

## 2D/3D医学图像配准框架

### X光成像模型

X-ray是高速运行的电子流撞击物质突然受阻时产生的一种波长极短、能量很大的电磁波，具有穿透性，但是人体组织的厚度和密度不同，X-ray在穿透人体时衰减程度不同从而会形成不同的影像。根据不同人体组织结构的密度高低和对X-ray的吸收的不同可以分为三类：高密度，有骨骼和钙化，在X光片上显示为白色；中等密度，有肌肉、内脏、结缔组织、软骨和液体等在X光片上显示为灰白色；低密度，有脂肪和气体在X光片上显示为灰黑色和深黑色

在均匀介质中，X-ray的衰减程度如下公式所示
$$
\begin{equation}
\begin{aligned}
I=I_0e^{-\mu l}
\end{aligned}
\end{equation}\tag{1}
$$
其中，$I$为X光沿路径衰减后的能量值，$I_0$为X射线源能量值，$\mu$为线性衰减系数，$l$为X射线在介质中穿过的路径长度
在不均匀介质中，X-ray衰减程度如下公式所示
$$
\begin{equation}
\begin{aligned}
I=I_0e^\int_L{-\mu(l)}dl
\end{aligned}
\end{equation}\tag{2}
$$
其中，$L$为X光路径长度。将X射线的衰减转化为物体密度，进而作为穿透路径对应的像素值，计算公式如下所示
$$
\begin{equation}
\begin{aligned}
p(L)=-\ln(\frac{I}{I_0})=\int_L\mu(l)dl
\end{aligned}
\end{equation}\tag{3}
$$
也就是说，X射线穿过介质的密度越小，对应图像灰度值越低

2D/3D配准首要解决的问题是实现维度统一，即把术前3D图像投影生成模拟的X射线2D图像，与术中2D图像在同一维度下进行配准，这就引出了数字重建放射影像(Digitally Reconstructured Radiograph, DRR)技术，它从模拟的X射线源想目标体素发射X-ray，在成像平面上获得像素的2D图像。Ray-Casting算法是DRR的主要实现方式
![[DRR生成示意图.png]]
<center><font color=silver>图1.2 DRR生成原理</font></center>
![[Ray-Casting算法.png]]
<center><font color=silver>图1.3 Ray-Casting算法示意图</font></center>
DRR图像上某一点的像素就是这点的能量，可以根据上述公式(2)进行计算

### CT成像模型

CT利用X线束扫描目标部位的层面，由接收器接收穿透过此层面的X射线，将其转换成可见光以后，由光电转换器转换成电信号，再有A/D转换器转成数字信号，最后输入计算机进行成像

CT值是对物体密度大小的计量单位，采用HU来度量人体组织对X射线吸收律，空气是-1000，水为0，致密骨为+1000，已知提速的线性衰减系数$\mu$时HU可由如下公式计算
$$
\begin{equation}
\begin{aligned}
HU=1000\times \frac{\mu-\mu_{water}}{\mu_{water}-\mu_{air}}
\end{aligned}
\end{equation}\tag{4}
$$
其中$\mu_{water}$和$\mu_{air}$分别是水和空气的线性衰减系数常见CT值如下表所示

<center><font color=silver>表1.1 人体常见组织器官CT值</font></center>

| 空气 | -1000 | 水     | 0     | 肺部   | -500    | 脂肪 | -100-50  |
| ---- | ----- | ------ | ----- | ------ | ------- | ---- | -------- |
| 血液 | 30-45 | 肌肉   | 10-40 | 软组织 | 100-300 | 骨骼 | 700-3000 |
| 肝脏 | 40-60 | 脑白质 | 20-30 | 脑灰质 | 37-45   | 肾脏 | 30       |

拉东变换(Radon Transform)是重建CT扫描的数学基础，这是一个积分变换，将定义在2D平面上的一个函数$f(x,y)$沿着平面上任意一条直线做线积分相当于对函数$f(x,y)$做CT扫描。
令函数$f(x,y)$在$\mathbb R^2$上有紧致支集，令$R$为Radon变换算子，则$Rf(x,y)=R(s,\alpha)$定义如下
$$
R(s,\alpha)=\int\int_{\mathbb R^2}f(x,y)\delta(x\cos\alpha+y\sin\alpha-s)dxdy\tag{5}
$$
其中$\delta$表示狄拉克函数/冲激函数。由狄拉克函数的限制($\delta(0)=1$)，上述积分沿着直线$x\cos\alpha+y\sin\alpha -s$进行，CT扫描可以沿着任意法方向$\alpha$、与原点成任意距离$s$的直线。得到$R(s,\alpha)$以后可以利用Radon变换的反演重构函数$f(x,y)$
为了实现Radon变换$R(s,\alpha)$的反演可以对变量$s$做Fourior积分得到下述公式
$$
\int_{-\infty}^\infty R(s,\alpha)e^{-iks}ds=\int\int_{\mathbb R^2}f(x,y)e^{-ik(x\cos\alpha+y\sin\alpha)}dxdy\tag{6}
$$
注意等式右边就是$f(x,y)$的二维Fourior变换，等价变形后可写为下述公式
$$
F(k_x,k_y)=\int\int_{\mathbb R^2}f(x,y)e^{-i(k_xx+k_yy)}dxdy\tag{7}
$$
其中$k_x=k\cos\alpha$，$k_y=k\sin\alpha$。对$F(k_x,k_y)$进行Fourior反变换可得到$f(x,y)$
$$
f(x,y)=\int\int_{\mathbb R^2}\frac{1}{(2\pi)^2}F(k_x,k_y)e^{i(k_xx+k_yy)}dk_xdk_y\tag{8}
$$

### 2D/3D医学图像配准问题的数学描述

进行配准前，先要统一维度。为了实现维度统一，可以选择将2D数据转化为3D数据，利用术中2D图像进行3D重建，再将浮动3D图像和重建3D图像进行配准，这就将2D/3D配准转化成了3D/3D配准；也可以选择将3D数据转化为2D数据，将3D浮动图像位置和姿态参数通过投影映射到2D空间进行优化求解

但是注意三维重建需要至少2张2D数据，2D图像越多重建效果会越好，这和实际情况相背离，而且若能成功重建3D数据，可以直接使用术中3D数据进行手术导航，配准失去意义。

对于术前3D浮动图像进行空间变幻并通过DRR投影渲染生成2D投影图像，计算投影图像和术中2D参考图像的相似性测度构建目标函数，然后运用参数优化优化目标函数，求解最优空间变换参数，使得DRR图像与术中2D参考图像最相似，2D/3D配准的数学表达式如下：
$$
T_g=\arg\max_TS(I_R,P(T(I_M)))
\tag{9}
$$
其中，$I_M$为浮动图像，$I_R$为参考图像，函数$S$为浮动图像与参考图像的相似测度。$T$是配准中的空间变换，$T_g$是配准后的空间变换，$P$是DRR投影，当浮动图和参考图完全配准时，DRR图像和参考图像在空间位置和像素值上相同，图像间关系表达为如下公式
$$
I_R=P(T_g(I_M))\tag{10}
$$
![[配准通用框架.png]]
<center><font color=silver>图1.4 配准通用框架</font></center>

## 2D/3D医学图像配准方法体系

### 传统迭代的方法

- 基于特征信息
	对灰度信息依赖小，配准过程简单，操作简单快捷，但是特征信息提取需要人工操作难以自动化，且
- 基于灰度信息
	使用远多于特征信息点的像素灰度信息完成配准，误差小、精度高，鲁棒性也较高，但是处理的信息过多，配准时间长无法实现实时配准
- 基于混合信息
	结合图像的特征信息和灰度信息，分为粗配准和精配准两步，第一步使用基于特征的配准算法进行粗配准，第二步将粗配准形变参数作为初始参数，使用基于绘图信息的配准进行精配准。粗配准减小了搜索空间保证计算效率

### 基于深度学习的方法

Wu、Simonovsky和Cheng等人利用深度学习技术计算两幅图像的相似性测度；
Miao和Yang等人使用CNN端到端地回归浮动图像到参考图像的形变场；
Hessam和Cao等人提出了3DCNN来端到端地预测两幅图像之间的形变场；
Mahapatra等人利用生成式对抗网络对胸部X光图像进行配准；
Hering等人利用多层次深度学习在不同尺度计算形变场；
Zhenlin Xu等人利用CNN共同学习配准和分割，使二者互补；
Hanqian Pan等人提出了一种基于阈值分割的方法加速配准；
Pingge Jiang等人研究了B样条系数优化之前使用CNN学习和腿短表达系数的多网格配置；
Yang X等人提出Quicksilver直接基于图像外观的变形模型来逐块配准；
Haofu Liao等人提出POI跟踪网络，利用X光和DRR之间的点对点对应关系直接测量配准误差；
Haskins G等人针对基于深度学习的生物医学图像配准问题进行了调研，对当下该领域的重难点、创新点进行剖析

## 2D/3D医学图像配准相关组件

### 空间变换

![[空间变换分类.png]]
<center><font color=silver>图1.5 空间变换分类</font></center>
- 刚体变换
	可以用平移和旋转完全描述
$$
\begin{equation}
\begin{aligned}
R_x&=
\begin{bmatrix}
1&0& 0\\
0&\cos r_x&-\sin r_x\\
0&\sin r_x&\cos r_x
\end{bmatrix}\\
R_y&=
\begin{bmatrix}
\cos r_y&0& \sin r_y\\
0&1&0\\
-\sin r_y&0&\cos r_y
\end{bmatrix}\\
R_z&=
\begin{bmatrix}
\cos r_z&-\sin r_z&0\\
-\sin r_z&\cos r_z&0\\
0&0&1
\end{bmatrix}\\
T&=(t_x,t_y,t_z)^T
\end{aligned}
\end{equation}\tag{11}
$$
	图像的刚体变换就可以表示为
	$$
	\begin{bmatrix}
	\tilde{x}\\
	\tilde{y}\\
	\tilde{z}
	\end{bmatrix}
	=
	R_xR_yR_z\begin{bmatrix}
	x\\
	y\\
	z
	\end{bmatrix}+T\tag{12}
	$$
	
- 仿射变换
	仿射变换包括平移、旋转两个刚体变换以及缩放、剪切和反转这样的非刚体变换，可以利用仿射矩阵进行计算
	$$
	Y=AX+T\tag{13}
	$$
	其中$A$称为仿射矩阵，它是一个$3\times 3$矩阵
- 投影变换
	将图片投影到一个新的平面，也称作投影映射。直线投影后仍然是直线，但是平行约束失效，参数通常为定值，如下公式所示
	$$
	[x',y',w']=[u,v,w]\begin{bmatrix}
	a_{11}&a_{12}&a_{13}\\
	a_{21}&a_{22}&a_{23}\\
	a_{31}&a_{32}&a_{33}
	\end{bmatrix}\tag{14}
	$$
	$u$、$v$是原图中的坐标，对应得到变换后的图像坐标$x$、$y$，其中$x=\frac{x'}{w'}$、$y=\frac{y'}{w'}$
- 非线性变换
	也称作弹性变换，能够将直线映射为曲线。我们可以将非线性变换拆分为仿射变换和非线性变换两部分，如下公式所示
	$$
	Y=AX+GW+T\tag{15}
	$$
	其中，$G$为高斯核，$W$为权值系数矩阵，$GW$为非线性变换
	在对人体软组织或一些器官进行配准时，会产生大量的局部形变，故需要引入非线性变换

根据需要配准的位置不同选择合适的空间变幻可以提高配准效率、优化配准精度，如心脏、肺部、胰腺等器官需要使用非刚体配准，而针对骨骼进行配准就可以采用刚体配准作为空间变换模型

仿射变换等价于刚体配准加上缩放操作，非线性变换则需要预测形变场，图像上每个像素点根据形变场对应位置的矢量进行变化

### 参数优化

- 梯度下降
	
- 牛顿法
	
- Powell优化/方向加速法
	

# 方法设计

## 基于深度学习和参数优化的2D/3D层级配准方法<a href="#art1">[1]</a>

先通过深度学习进行粗配准，再使用参数优化方法对两块椎骨进行精配准，同时保证了刚体的整体形变和局部形变信息。

## 基于生成对抗网络的2D/3D配准方法

先训练一个可以生成符合椎骨之间关节约束的相对形变参数生成器$G$，再对生成的形变参数进行参数优化。

# 实验结果



# 总结



# 参考文献

<a id="art1">[1]</a> [基于深度学习网络的2D/3D脊椎CT层级配准方法](文献/基于深度学习网络的2D-3D脊椎CT层级配准方法/基于深度学习网络的2D-3D脊椎CT层级配准方法)